name: 'Deployment'

on:
  pull_request:

jobs:
  cluster-app:
    name: 'Deployment'
    runs-on: ubuntu-latest
    steps:
     # Checkout the repository to the GitHub Actions runner
     # Setup gcloud CLI
       - uses: GoogleCloudPlatform/github-actions/setup-gcloud@0.1.3
         with:
           service_account_key: ${{ secrets.GKE_SA_KEY }}
           project_id: ${{ secrets.GCP_PROJECT_ID }}
       # Configure Docker to use the gcloud command-line tool as a credential
       # helper for authentication
       - name: GCLOUD
         run: |-
           gcloud --quiet auth configure-docker
       # Get the GKE credentials so we can deploy to the cluster
       - name: GKE credentials
         run: |-
       gcloud container clusters get-credentials terra-cluster --zone us-central1
       # Get the GKE credentials so we can deploy to the cluster
       - name: deploy cluster
         uses: google-github-actions/get-gke-credentials@fb08709ba27618c31c09e014e1d8364b02e5042e
         with:
           cluster_name: terra-cluster
           location: us-central1
           credentials: ${{ secrets.GKE_SA_KEY }}

       # Build the Docker image
       - name: Build
         run: |-
           docker build \
             --tag "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
             --build-arg GITHUB_SHA="$GITHUB_SHA" \
             --build-arg GITHUB_REF="$GITHUB_REF" \
             .

       # Push the Docker image to Google Container Registry
       - name: Publish
         run: |-
           docker push "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA"


